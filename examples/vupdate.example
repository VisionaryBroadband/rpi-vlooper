#!/bin/bash
#source

# Get into the scripts home directory
cd "$baseDir" || { echo "Failed to cd into $baseDir" >> "$log"; exit 1; }

# Check the Video folder for new media
cd "$videoDir"
src=$(ls -t ./*.mp4 | head -n1)

# Check result of src, if not null then process video
if [[ -n "$src" ]]
  then
    # Check if new file is the same as the current file, if not then process video
    if [ "$src" == "$curVideo" ]
      then
        echo "$timeStamp - No new video found" >> "$log"
      else
        echo "$timeStamp - New file found, initiating video update process..." >> "$log"
        echo "$timeStamp - Currently running video ... $curVideo" >> "$log"
        echo "$timeStamp - New video found ... $src" >> "$log"
        newFile="\'$videoDir/$src\'"
        if ! sed -i "s|^curVideo=.*|curVideo=$newFile|" "$baseDir/inc/main.cfg"
          then
            echo -e "$timeStamp - Could not update configuration file" >> "$log"
            exit 1
          else
            echo -e "$timestamp - Configuration file updated successfully" >> "$log"
        fi

        # Check if omxplayer is running and terminate if it is
        if [[ -n $omxPid ]]
        then
          echo "$timeStamp -- Stopping Video Looper..." >> "$log"
          if ! sudo systemctl stop vlooper
            then
              echo "$timeStamp ---- Failed to stop vlooper!" >> "$log"
              exit 1
            else
              echo "$timeStamp ---- Stopped vlooper" >> "$log"
          fi
        fi

        # Change new file ownership to installed user
        if ! chown "$fileOwner":"$fileOwner" "$videoDir/$src"
          then
            echo "$timeStamp -- Failed to set ownership of video!" >> "$log"
          else
            echo "$timeStamp -- Set ownership on video" >> "$log"
        fi

        #Start videolooper. If success send to log.
        if ! sudo systemctl start vlooper
          then
            echo "$timeStamp -- Failed to start vlooper!" >> "$log"
          else
            echo "$timeStamp -- Started vlooper" >> "$log"
        fi
    fi
  else
    echo "$timeStamp - No new video found" >> "$log"
fi